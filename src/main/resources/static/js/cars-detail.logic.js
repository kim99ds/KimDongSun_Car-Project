/**
 * cars-detail.logic.js
 * - 기존 기능 로직(트림 API 호출, 옵션/패키지 렌더링, 제약, 가격, 요약칩, 좋아요, 견적 제출)
 * - 현재 HTML 구조(빌더 UI)와 legacy 라디오 구조를 동시에 지원
 */
document.addEventListener("DOMContentLoaded", () => {
  let basePrice = 0;

  const lockedBy = new Map();
  const lockedPkgBy = new Map();

  // ✅ 스포츠 패키지 ID(고정 fallback) + (전역 packageOptions 존재 시에만 스캔)
  const SPORT_PKG_ID = (() => {
    try {
      const pArr = (typeof packageOptions !== "undefined" && Array.isArray(packageOptions)) ? packageOptions : [];
      const p = pArr.find(x => String(x?.optionName || '').includes('스포츠 패키지'));
      const id = p ? Number(p.optionId ?? p.optionItemId ?? p.id) : 21256;
      return Number.isFinite(id) && id > 0 ? id : 21256;
    } catch (e) {
      return 21256;
    }
  })();

  function upper(v){ return String(v || "").toUpperCase(); }

  function toNumber(v){
    const n = Number(String(v ?? "0").replaceAll(",", ""));
    return Number.isNaN(n) ? 0 : n;
  }

  function isAutoGeneratedChild(opt) {
    const desc = String(opt?.optionDesc || "");
    return desc.startsWith("AUTO-GENERATED (package child):");
  }

  function parseRequiresFromDataset(el){
    const raw = (el?.dataset?.requires || '').trim();
    if (!raw) return [];
    return raw.split(',').map(s => Number(s.trim())).filter(n => !Number.isNaN(n));
  }

  function parseExcludesFromDataset(el){
    const raw = (el?.dataset?.excludes || '').trim();
    if (!raw) return [];
    return raw.split(',').map(s => Number(s.trim())).filter(n => !Number.isNaN(n));
  }

  function getSelectedIdSet(){
    const set = new Set();

    document.querySelectorAll('#option-area .option-checkbox:checked').forEach(cb => {
      const id = Number(cb.dataset.optionId);
      if (!Number.isNaN(id)) set.add(id);
    });

    document.querySelectorAll('#package-area .package-checkbox:checked').forEach(cb => {
      const id = Number(cb.dataset.packageId);
      if (!Number.isNaN(id)) set.add(id);
    });

    return set;
  }

  // ✅ 기본품목(필수) 유지 (checkbox만)
  function keepRequiredChecked(){
    document.querySelectorAll('#option-area .option-checkbox').forEach(cb => {
      if (cb.disabled) return;
      if (cb.dataset.pkgLocked === 'Y') return;
      if (cb.dataset.required === 'Y' && cb.type === 'checkbox') {
        cb.checked = true;
      }
    });
  }

  // ✅ "선택불가" 배지 동기화
  function syncDisabledBadges(){
    const pairs = [
      ...Array.from(document.querySelectorAll('#option-area .option-checkbox')).map(cb => ({cb, kind:'opt'})),
      ...Array.from(document.querySelectorAll('#package-area .package-checkbox')).map(cb => ({cb, kind:'pkg'}))
    ];

    pairs.forEach(({cb, kind}) => {
      const label = cb.closest('label');
      if (!label) return;

      const locked = cb.dataset.pkgLocked === 'Y';
      const required = cb.dataset.required === 'Y';

      // ✅ 스포츠패키지는 "항상 선택 가능"처럼 보여야 함
      if (kind === 'pkg' && Number(cb.dataset.packageId) === SPORT_PKG_ID) {
        cb.dataset.softDisabled = "N";
        const row = cb.closest('.package-box') || cb.closest('div');
        if (row) row.classList.remove('option-disabled-row');
        const badge = label.querySelector('.disabled-badge');
        if (badge) badge.remove();
        return;
      }

      const softDisabled = cb.dataset.softDisabled === "Y";
      const visuallyDisabled = cb.disabled || softDisabled;

      const row = cb.closest('.option-item, .package-box, .package-item') || cb.closest('div');
      if (row) row.classList.toggle('option-disabled-row', visuallyDisabled && !locked && !required);

      let badge = label.querySelector('.disabled-badge');
      if (visuallyDisabled && !locked && !required) {
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'disabled-badge';
          badge.textContent = '선택불가';
          label.appendChild(badge);
        }
      } else {
        if (badge) badge.remove();
      }
    });
  }

  // =========================================
  // ✅ SINGLE(라디오) 그룹키 분리
  // =========================================
  function leftOfPipe(name){
    const s = String(name || "");
    const idx = s.indexOf("|");
    if (idx < 0) return s.trim();
    return s.slice(0, idx).trim();
  }
  function normalizeEngineKey(prefix){
    return String(prefix || "").replaceAll("_스포츠", "").trim();
  }
  function getSingleRadioGroupKey(opt){
    const name = String(opt?.optionName || "");
    const groupCode = upper(opt?.optionCategory);

    if (name.includes("휠&타이어")) {
      const engineKey = normalizeEngineKey(leftOfPipe(name));
      return `SINGLE_WHEEL_${engineKey || groupCode}`;
    }

    if (name.includes("내장 디자인")) return "SINGLE_INTERIOR_DESIGN";
    if (name.includes("내장 컬러")) return "SINGLE_INTERIOR_COLOR";

    return `SINGLE_${groupCode}`;
  }

  // =========================================
  // ✅ 스포츠패키지 선택 시 기본값 보조
  // =========================================
  let _autoSportApplying = false;

  function getLabelTextOfCheckbox(cb){
    const label = cb.closest("label");
    if (!label) return "";
    return (label.textContent || "").trim().split("\n")[0].trim();
  }

  function isSportWheelOption(cb){
    const t = getLabelTextOfCheckbox(cb);
    return t.includes("휠&타이어") && t.includes("(스포츠)");
  }

  function isSportInteriorDesignOption(cb){
    const t = getLabelTextOfCheckbox(cb);
    return t.includes("내장 디자인_스포츠");
  }

  function pickCheapestEnabled(candidates){
    const enabled = candidates.filter(cb => !cb.disabled && cb.dataset.pkgLocked !== "Y");
    if (!enabled.length) return null;
    enabled.sort((a,b) => toNumber(a.dataset.price) - toNumber(b.dataset.price));
    return enabled[0];
  }

  function applySportPackageDefaults(){
    if (_autoSportApplying) return;

    const sportPkg = document.querySelector(`#package-area .package-checkbox[data-package-id="${SPORT_PKG_ID}"]`);
    if (!sportPkg || !sportPkg.checked) return;

    _autoSportApplying = true;
    try{
      const opts = Array.from(document.querySelectorAll("#option-area .option-checkbox"));

      const sportWheelCbs = opts.filter(isSportWheelOption);
      const anySportWheelChecked = sportWheelCbs.some(cb => cb.checked);
      if (!anySportWheelChecked){
        const defWheel = pickCheapestEnabled(sportWheelCbs);
        if (defWheel) {
          defWheel.checked = true;
          defWheel.dispatchEvent(new Event("change", { bubbles:true }));
        }
      }

      const sportInteriorCbs = opts.filter(isSportInteriorDesignOption);
      const anySportInteriorChecked = sportInteriorCbs.some(cb => cb.checked);
      if (!anySportInteriorChecked){
        const defInterior = pickCheapestEnabled(sportInteriorCbs);
        if (defInterior) {
          defInterior.checked = true;
          defInterior.dispatchEvent(new Event("change", { bubbles:true }));
        }
      }

    } finally {
      _autoSportApplying = false;
    }
  }

  // =========================================
  // ✅ 스포츠패키지 우선권: 충돌 해결
  // =========================================
  function cssEscapeSafe(v){
    if (window.CSS && CSS.escape) return CSS.escape(String(v));
    return String(v).replaceAll('"', '\\"');
  }

  function resolvePackageExcludesPreferPackage(pkgId){
    const pkgCb = document.querySelector(`#package-area .package-checkbox[data-package-id="${pkgId}"]`);
    if (!pkgCb) return { ok:false, reason:`패키지 체크박스 없음 (pkgId=${pkgId})` };

    const excludes = parseExcludesFromDataset(pkgCb);
    if (!excludes.length) return { ok:true };

    const selected = getSelectedIdSet();
    const conflicts = excludes.filter(x => selected.has(x));
    if (!conflicts.length) return { ok:true };

    for (const conflictId of conflicts){

      // (1) 옵션 충돌
      const optCb = document.querySelector(`#option-area .option-checkbox[data-option-id="${conflictId}"]`);
      if (optCb){
        if (optCb.dataset.pkgLocked === "Y"){
          return { ok:false, reason:`패키지 포함으로 잠긴 옵션이라 해제 불가: ${conflictId}` };
        }

        if (optCb.type === "checkbox"){
          if (optCb.dataset.required === "Y"){
            return { ok:false, reason:`필수 옵션이라 해제 불가: ${conflictId}` };
          }
          optCb.checked = false;
          continue;
        }

        if (optCb.type === "radio"){
          const groupName = optCb.name;
          optCb.checked = false;

          const radios = Array.from(document.querySelectorAll(
            `#option-area input.option-checkbox[type="radio"][name="${cssEscapeSafe(groupName)}"]`
          ));

          const candidates = radios.filter(r => {
            const id = Number(r.dataset.optionId);
            if (Number.isNaN(id)) return false;
            if (id === conflictId) return false;
            if (r.disabled) return false;
            if (r.dataset.policyLocked === "Y") return false;
            if (r.dataset.pkgLocked === "Y") return false;

            const ex = parseExcludesFromDataset(r);
            if (ex.includes(pkgId)) return false;

            return true;
          });

          if (candidates.length){
            candidates.sort((a,b) => toNumber(a.dataset.price) - toNumber(b.dataset.price));
            candidates[0].checked = true;
          }
          continue;
        }
      }

      // (2) 패키지 충돌
      const otherPkgCb = document.querySelector(`#package-area .package-checkbox[data-package-id="${conflictId}"]`);
      if (otherPkgCb){
        if (otherPkgCb.dataset.pkgLocked === "Y"){
          return { ok:false, reason:`포함으로 잠긴 패키지라 해제 불가: ${conflictId}` };
        }
        otherPkgCb.checked = false;
        continue;
      }

      return { ok:false, reason:`충돌 대상을 화면에서 찾지 못함: ${conflictId}` };
    }

    return { ok:true };
  }

  function trySelectSportPackage(){
    const pkgCb = document.querySelector(`#package-area .package-checkbox[data-package-id="${SPORT_PKG_ID}"]`);
    if (!pkgCb) return;

    const r = resolvePackageExcludesPreferPackage(SPORT_PKG_ID);
    if (!r.ok){
      alert(`스포츠 패키지를 선택할 수 없습니다.\n사유: ${r.reason}`);
      return;
    }

    pkgCb.checked = true;
    pkgCb.dispatchEvent(new Event("change", { bubbles:true }));
  }

  // =========================================
  // ✅ 6015 선택 시: 휠&타이어/내장디자인은 스포츠만 선택 가능
  // =========================================
  function enforceSportOnlyWhenPackageSelected(){
    const pkg = document.querySelector(`#package-area .package-checkbox[data-package-id="${SPORT_PKG_ID}"]`);
    const on = !!(pkg && pkg.checked);

    const opts = Array.from(document.querySelectorAll("#option-area .option-checkbox"));

    const isWheel = (cb) => getLabelTextOfCheckbox(cb).includes("휠&타이어");
    const isInteriorDesign = (cb) => getLabelTextOfCheckbox(cb).includes("내장 디자인");
    const isSportWheel = (cb) => isSportWheelOption(cb);
    const isSportDesign = (cb) => isSportInteriorDesignOption(cb);

    opts.forEach(cb => {
      if (cb.dataset.pkgLocked === "Y") return;

      const inTarget = (isWheel(cb) || isInteriorDesign(cb));
      if (!inTarget) return;

      if (on) {
        const allow =
          (isWheel(cb) ? isSportWheel(cb) : true) &&
          (isInteriorDesign(cb) ? isSportDesign(cb) : true);

        if (!allow) {
          if (cb.checked) cb.checked = false;
          cb.dataset.policyLocked = "Y";
          cb.disabled = true;
        } else {
          if (cb.dataset.policyLocked === "Y") cb.dataset.policyLocked = "N";
        }
      } else {
        if (cb.dataset.policyLocked === "Y") cb.dataset.policyLocked = "N";
      }
    });

    if (on) applySportPackageDefaults();
  }

  // =========================================
  // ✅ 제약 처리
  // =========================================
  function enforceRequiresConstraints(){
    keepRequiredChecked();

    const selected = getSelectedIdSet();

    // 1) 일반 옵션(requires)
    document.querySelectorAll('#option-area .option-checkbox').forEach(cb => {
      if (cb.dataset.policyLocked === "Y") return;
      if (cb.dataset.pkgLocked === 'Y') return;
      if (cb.dataset.required === 'Y') return;

      const requires = parseRequiresFromDataset(cb);
      if (!requires.length) {
        cb.disabled = false;
        return;
      }

      const ok = requires.every(reqId => selected.has(reqId));
      if (!ok) {
        cb.disabled = true;
        if (cb.checked) cb.checked = false;
      } else {
        cb.disabled = false;
      }
    });

    // 2) 패키지 옵션(requires)
    document.querySelectorAll('#package-area .package-checkbox').forEach(cb => {
      if (cb.dataset.pkgLocked === 'Y') return;

      const requires = parseRequiresFromDataset(cb);
      if (!requires.length) {
        cb.disabled = false;
        return;
      }

      const ok = requires.every(reqId => selected.has(reqId));
      if (!ok) {
        cb.disabled = true;
        if (cb.checked) cb.checked = false;
      } else {
        cb.disabled = false;
      }
    });

    enforceExcludesConstraints();
    enforceSportOnlyWhenPackageSelected();

    keepRequiredChecked();
    syncDisabledBadges();
    updateTotalPrice();
    updateSelectedSummary();
  }

  function enforceExcludesConstraints(){
    const selected = getSelectedIdSet();

    // 1) 일반 옵션(excludes)
    document.querySelectorAll('#option-area .option-checkbox').forEach(cb => {
      if (cb.dataset.policyLocked === "Y") return;
      if (cb.dataset.pkgLocked === 'Y') return;
      if (cb.dataset.required === 'Y') return;

      const excludes = parseExcludesFromDataset(cb);
      if (!excludes.length) return;

      const conflict = excludes.some(x => selected.has(x));
      if (conflict) {
        cb.disabled = true;
        if (cb.checked) cb.checked = false;
      }
    });

    // 2) 패키지 옵션(excludes)
    document.querySelectorAll('#package-area .package-checkbox').forEach(cb => {
      if (cb.dataset.pkgLocked === 'Y') return;

      const pkgId = Number(cb.dataset.packageId);
      const excludes = parseExcludesFromDataset(cb);

      if (!excludes.length) {
        cb.dataset.softDisabled = "N";
        cb.disabled = false;
        return;
      }

      const conflict = excludes.some(x => selected.has(x));

      if (conflict) {
        // ✅ 스포츠는 절대 disabled 금지
        if (pkgId === SPORT_PKG_ID) {
          cb.dataset.softDisabled = "N";
          cb.disabled = false;
          return;
        }

        cb.dataset.softDisabled = "N";
        cb.disabled = true;
        if (cb.checked) cb.checked = false;
      } else {
        cb.dataset.softDisabled = "N";
        cb.disabled = false;
      }
    });

    keepRequiredChecked();
    syncDisabledBadges();
  }

  // ✅ UX: requires 자동 체크(가능한 경우에만)
  function autoSelectRequires(startEl){
    const visited = new Set();
    function _walk(el){
      const reqIds = parseRequiresFromDataset(el);
      reqIds.forEach(reqId => {
        if (visited.has(reqId)) return;
        visited.add(reqId);

        const optCb = document.querySelector(`#option-area .option-checkbox[data-option-id="${reqId}"]`);
        if (optCb && !optCb.disabled && optCb.dataset.pkgLocked !== 'Y') {
          if (!optCb.checked) {
            optCb.checked = true;
            optCb.dispatchEvent(new Event("change", { bubbles:true }));
          }
          _walk(optCb);
          return;
        }

        const pkgCb = document.querySelector(`#package-area .package-checkbox[data-package-id="${reqId}"]`);
        if (pkgCb && !pkgCb.disabled && pkgCb.dataset.pkgLocked !== 'Y') {
          if (!pkgCb.checked) {
            pkgCb.checked = true;
            pkgCb.dispatchEvent(new Event("change", { bubbles:true }));
          }
          _walk(pkgCb);
        }
      });
    }
    _walk(startEl);
  }

  // ✅ disabled 옵션 클릭 시에도 requires 강제 선행 선택
  function forceSelectRequires(startEl){
    const visited = new Set();

    function _walk(el){
      const reqIds = parseRequiresFromDataset(el);

      for (const reqId of reqIds){
        if (visited.has(reqId)) continue;
        visited.add(reqId);

        const optCb = document.querySelector(`#option-area .option-checkbox[data-option-id="${reqId}"]`);
        if (optCb) {
          if (optCb.dataset.pkgLocked === "Y") continue;
          if (optCb.dataset.policyLocked === "Y") continue;
          if (!optCb.checked) optCb.checked = true;
          _walk(optCb);
          continue;
        }

        const pkgCb = document.querySelector(`#package-area .package-checkbox[data-package-id="${reqId}"]`);
        if (pkgCb) {
          if (pkgCb.dataset.pkgLocked === "Y") continue;
          if (!pkgCb.checked) pkgCb.checked = true;
          _walk(pkgCb);
        }
      }
    }

    _walk(startEl);
  }

  /* ================= ✅ 좋아요 토글 ================= */
  const likeBtn = document.getElementById("like-btn");
  const likeText = document.getElementById("like-btn-text");
  const likeCountEl = document.getElementById("like-count");

  function renderLike(dto){
    const liked = !!dto.liked;
    if (likeBtn) likeBtn.dataset.liked = liked ? "true" : "false";
    if (likeText) likeText.textContent = liked ? "♥ 좋아요 취소" : "♡ 좋아요";
    if (likeCountEl) likeCountEl.textContent = Number(dto.likeCount || 0).toLocaleString();
  }

  async function fetchLikeStatus(modelId){
    const res = await fetch(`/api/models/${modelId}/likes`);
    if (!res.ok) throw new Error("LIKE STATUS FAIL");
    return res.json();
  }

  async function like(modelId){
    const res = await fetch(`/api/models/${modelId}/likes`, { method: "POST" });
    if (res.status === 401) { alert("로그인이 필요합니다."); return null; }
    if (!res.ok) throw new Error("LIKE FAIL");
    return res.json();
  }

  async function unlike(modelId){
    const res = await fetch(`/api/models/${modelId}/likes`, { method: "DELETE" });
    if (res.status === 401) { alert("로그인이 필요합니다."); return null; }
    if (!res.ok) throw new Error("UNLIKE FAIL");
    return res.json();
  }

  (function initLike(){
    const modelIdFromBtn = likeBtn?.dataset?.modelId;
    const modelIdFallback = document.querySelector("[data-model-id]")?.dataset?.modelId;
    const modelId = modelIdFromBtn || modelIdFallback;

    if (!modelId) return;

    fetchLikeStatus(modelId)
      .then(renderLike)
      .catch(console.error);

    if (!likeBtn) return;

    likeBtn.addEventListener("click", async () => {
      const liked = likeBtn.dataset.liked === "true";
      try {
        likeBtn.disabled = true;
        const dto = liked ? await unlike(modelId) : await like(modelId);
        if (dto) renderLike(dto);
      } catch (e) {
        console.error(e);
        alert("좋아요 처리 중 오류가 발생했습니다.");
      } finally {
        likeBtn.disabled = false;
      }
    });
  })();

  /* ================= ✅ 견적서 제출 ================= */
  const quoteBtn = document.getElementById("submit-quote-btn");
  const quoteMsg = document.getElementById("quote-msg");

  function getSelectedVariantId() {
    return document.querySelector("input[name='variantId']:checked")?.value || null;
  }
  function getSelectedTrimId() {
    return document.querySelector("input[name='trimId']:checked")?.value || null;
  }
  function getSelectedTrimColorId() {
    const sel = document.getElementById("trimColorSelect");
    return sel && sel.value ? sel.value : null;
  }
  function getSelectedPackageOptionIds() {
    return Array.from(document.querySelectorAll("#package-area input.package-checkbox:checked"))
      .map(el => Number(el.dataset.packageId));
  }
  function getSelectedSingleOptionIds() {
    return Array.from(document.querySelectorAll("#option-area .option-checkbox:checked"))
      .map(el => Number(el.dataset.optionId));
  }
  function getTotalPriceNumber() {
    const txt = document.getElementById("total-price")?.textContent || "0";
    return Number(String(txt).replaceAll(",", "")) || 0;
  }

  async function submitQuote(payload) {
    const res = await fetch("/api/quotes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const ct = res.headers.get("content-type") || "";

    if (res.redirected || ct.includes("text/html")) return { __unauthorized: true };
    if (res.status === 401 || res.status === 403) return { __unauthorized: true };

    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error("QUOTE SUBMIT FAIL: " + text);
    }
    return res.json();
  }

  quoteBtn?.addEventListener("click", async (e) => {
    const btn = e.currentTarget;
    const modelId = Number(btn.dataset.modelId);

    const variantId = getSelectedVariantId();
    const trimId = getSelectedTrimId();
    const trimColorId = getSelectedTrimColorId();

    if (!variantId) return alert("엔진을 선택해주세요.");
    if (!trimId) return alert("트림을 선택해주세요.");
    if (!trimColorId) return alert("색상을 선택해주세요.");

    const payload = {
      modelId,
      variantId: Number(variantId),
      trimId: Number(trimId),
      trimColorId: Number(trimColorId),
      packageOptionIds: getSelectedPackageOptionIds(),
      singleOptionIds: getSelectedSingleOptionIds(),
      totalPrice: getTotalPriceNumber()
    };

    quoteMsg.textContent = "제출 중...";

    try {
      btn.disabled = true;

      const data = await submitQuote(payload);

      if (data && data.__unauthorized) {
        quoteMsg.textContent = "";
        alert("로그인이 필요합니다.");
        return;
      }

      quoteMsg.textContent = "견적서 제출 완료!";

      if (data?.quoteId) location.href = `/quotes/${data.quoteId}`;

    } catch (err) {
      console.error(err);
      quoteMsg.textContent = "";
      alert("견적서 제출에 실패했습니다.");
    } finally {
      btn.disabled = false;
    }
  });

  // ===== legacy 라디오 이벤트: 엔진/트림 변경 → API 호출 흐름 유지 =====
  document.querySelectorAll("input[name='variantId']").forEach(radio => {
    radio.addEventListener("change", () => showTrimsForEngine(radio.value));
  });

  document.querySelectorAll(".trim-radio").forEach(radio => {
    radio.addEventListener("change", () => loadTrimDetail(radio.value));
  });

  document.getElementById("color-area")?.addEventListener("change", updateTotalPrice);

  // ✅ package-area: 스포츠패키지는 disabled/softDisabled여도 클릭 시도 허용(충돌정리 후 체크)
  document.getElementById("package-area")?.addEventListener("pointerdown", (e) => {
    const box = e.target.closest(".package-box");
    if (!box) return;

    const cb = box.querySelector("input.package-checkbox");
    if (!cb) return;

    const pkgId = Number(cb.dataset.packageId);

    if (
      pkgId === SPORT_PKG_ID &&
      (cb.disabled || cb.dataset.softDisabled === "Y") &&
      cb.dataset.pkgLocked !== "Y"
    ) {
      e.preventDefault();
      e.stopPropagation();
      trySelectSportPackage();
      return;
    }

    if (cb.dataset.pkgLocked === "Y") {
      e.preventDefault();
      e.stopPropagation();
      cb.checked = true;
    }
  }, true);

  // ✅ package-area change: 여기 "한 군데"에서만 처리
  document.getElementById("package-area")?.addEventListener("change", (e) => {
    const t = e.target;
    if (!t.classList || !t.classList.contains("package-checkbox")) return;

    const pkgId = Number(t.dataset.packageId);

    if (t.dataset.pkgLocked === "Y") {
      t.checked = true;
      return;
    }

    // ✅ 스포츠는 체크 시 먼저 충돌 정리
    if (pkgId === SPORT_PKG_ID && t.checked) {
      const r = resolvePackageExcludesPreferPackage(SPORT_PKG_ID);
      if (!r.ok) {
        alert(`스포츠 패키지를 선택할 수 없습니다.\n사유: ${r.reason}`);
        t.checked = false;
        return;
      }
    }

    if (t.checked) autoSelectRequires(t);

    applyPackageCascade(pkgId, t.checked);
    enforceRequiresConstraints();
  });

  // 옵션 영역 이벤트 위임
  document.getElementById("option-area")?.addEventListener("click", handleOptionClick);
  document.getElementById("option-area")?.addEventListener("change", handleOptionChange);

  function showTrimsForEngine(variantId) {
    document.querySelectorAll(".trim-container").forEach(c => c.style.display = "none");
    const container = document.querySelector(`input[name='variantId'][value='${variantId}']`)
      ?.closest("div")?.querySelector(".trim-container");
    if (container) container.style.display = "block";
    document.querySelectorAll("input[name='trimId']").forEach(r => r.checked = false);
    resetSelection();
  }

  function resetSelection() {
    const colorArea = document.getElementById("color-area");
    const packageArea = document.getElementById("package-area");
    const optionArea = document.getElementById("option-area");
    const optionTabs = document.getElementById("option-tabs");
    const totalPrice = document.getElementById("total-price");

    if (colorArea) colorArea.innerHTML = "<p>트림을 선택해주세요</p>";
    if (packageArea) packageArea.innerHTML = "<p>트림을 선택해주세요</p>";
    if (optionArea) optionArea.innerHTML = "<p>트림을 선택해주세요</p>";
    if (optionTabs) { optionTabs.style.display = "none"; optionTabs.innerHTML = ""; }
    if (totalPrice) totalPrice.textContent = "0";

    basePrice = 0;
    lockedBy.clear();
    lockedPkgBy.clear();
  }

  function loadTrimDetail(trimId) {
    fetch(`/api/trims/${trimId}`)
      .then(res => { if (!res.ok) throw new Error("API ERROR"); return res.json(); })
      .then(data => {
        basePrice = Number(data.basePrice || 0);
        lockedBy.clear();
        lockedPkgBy.clear();

        const allOptions = (data.options || []).filter(o => !isAutoGeneratedChild(o));
        const packageOptions = allOptions.filter(o => upper(o.optionType) === "PACKAGE");
        const singleOptions  = allOptions.filter(o => upper(o.optionType) === "SINGLE");

        renderColors(data.colors || []);
        renderPackages(packageOptions);
        renderOptionsByCategoryWithTabs(singleOptions);

        keepRequiredChecked();
        enforceRequiresConstraints();
      })
      .catch(err => {
        console.error(err);
        alert("트림 정보를 불러오지 못했습니다.");
      });
  }

  function renderColors(colors) {
    const area = document.getElementById("color-area");
    if (!area) return;

    // ensure select exists
    let sel = document.getElementById("trimColorSelect");
    if (!sel) {
      area.innerHTML = `<select id="trimColorSelect" name="build-color"><option value="">색상 선택</option></select>`;
      sel = document.getElementById("trimColorSelect");
    }

    // reset options
    sel.innerHTML = `<option value="">색상 선택</option>`;

    if (!colors || !colors.length) return;

    colors.forEach(c => {
      const price = Number(c.colorPrice || 0);
      const trimColorId = (c && c.trimColorId != null) ? String(c.trimColorId) : "";
      const name = c.colorName || "";
      const opt = document.createElement("option");
      opt.value = trimColorId;
      opt.textContent = `${name} (${price.toLocaleString()}원)`;
      opt.dataset.price = String(price);
      sel.appendChild(opt);
    });
  }

  function renderPackages(packageOptions) {
    const area = document.getElementById("package-area");
    if (!area) return;

    area.innerHTML = "";
    if (!packageOptions.length) { area.innerHTML = "<p>선택 가능한 패키지가 없습니다</p>"; return; }

    packageOptions.forEach(p => {
      const pkgId = Number(p.optionId);
      const pkgName = p.optionName || "패키지";
      const pkgPrice = Number(p.optionPrice || 0);

      const requiresArr = Array.isArray(p.requiresOptionIds) ? p.requiresOptionIds : [];
      const requiresAttr = requiresArr.map(n => Number(n)).filter(n => !Number.isNaN(n)).join(',');

      const excludesArr = Array.isArray(p.excludesOptionIds) ? p.excludesOptionIds : [];
      const excludesAttr = excludesArr.map(n => Number(n)).filter(n => !Number.isNaN(n)).join(',');

      const children = (p.includedOptions || []).map(ch => {
        const childId = Number(ch.optionId);
        const childName = ch.optionName || "구성품";
        return `<li data-child-id="${childId}">${childName} <span class="muted">(포함)</span></li>`;
      }).join("");

      area.insertAdjacentHTML("beforeend", `
        <div class="package-box" data-package-box-id="${pkgId}">
          <label>
            <input type="checkbox"
                   class="package-checkbox"
                   data-package-id="${pkgId}"
                   data-price="${pkgPrice}"
                   data-requires="${requiresAttr}"
                   data-excludes="${excludesAttr}"
                   data-pkg-locked="N"
                   data-soft-disabled="N">
            <strong>${pkgName}</strong> (${pkgPrice.toLocaleString()}원)
          </label>
          <ul>${children || "<li><span class='muted'>구성품 정보 없음</span></li>"}</ul>
        </div>
      `);
    });
  }

  function getPackageChildIds(pkgId) {
    const box = document.querySelector(`#package-area .package-box[data-package-box-id="${pkgId}"]`);
    if (!box) return [];
    return Array.from(box.querySelectorAll(`li[data-child-id]`))
      .map(li => Number(li.dataset.childId))
      .filter(n => !Number.isNaN(n));
  }

  // ✅ 스포츠패키지 child 옵션은 잠금 처리하지 않음(안전장치)
  function applyPackageCascade(pkgId, isChecked) {
    const childIds = getPackageChildIds(pkgId);

    childIds.forEach(childId => {
      const childPkgCb = document.querySelector(`#package-area .package-checkbox[data-package-id="${childId}"]`);
      if (childPkgCb) {
        if (!lockedPkgBy.has(childId)) lockedPkgBy.set(childId, new Set());
        const set = lockedPkgBy.get(childId);

        if (isChecked) set.add(pkgId);
        else set.delete(pkgId);

        applyPackageCheckboxLock(childId);

        const locked = set && set.size > 0;
        applyPackageCascade(childId, locked);
        return;
      }

      // ✅ [중요] 스포츠 child 옵션은 잠금 금지
      if (pkgId === SPORT_PKG_ID) return;

      if (!lockedBy.has(childId)) lockedBy.set(childId, new Set());
      const optSet = lockedBy.get(childId);

      if (isChecked) optSet.add(pkgId);
      else optSet.delete(pkgId);

      applyOptionLock(childId);
    });

    resortAllPanelsSelectedFirst();
    enforceRequiresConstraints();
    updateTotalPrice();
  }

  function applyPackageCheckboxLock(packageId) {
    const cb = document.querySelector(`#package-area .package-checkbox[data-package-id="${packageId}"]`);
    if (!cb) return;

    const lockers = lockedPkgBy.get(packageId);
    const isLocked = lockers && lockers.size > 0;

    const label = cb.closest("label");
    if (!label) return;

    if (isLocked) {
      if (cb.dataset.prevChecked === undefined) cb.dataset.prevChecked = cb.checked ? "Y" : "N";
      if (cb.dataset.originalPrice === undefined) cb.dataset.originalPrice = String(cb.dataset.price || "0");

      cb.checked = true;
      cb.dataset.price = "0";
      cb.disabled = true;
      cb.dataset.pkgLocked = "Y";
      cb.dataset.softDisabled = "N";

      if (!label.querySelector(".pkg-included-badge")) {
        const badge = document.createElement("span");
        badge.className = "pkg-included-badge";
        badge.textContent = "[패키지 포함]";
        label.appendChild(badge);
      }
    } else {
      const badge = label.querySelector(".pkg-included-badge");
      if (badge) badge.remove();

      if (cb.dataset.originalPrice !== undefined) cb.dataset.price = cb.dataset.originalPrice;
      if (cb.dataset.prevChecked !== undefined) {
        cb.checked = (cb.dataset.prevChecked === "Y");
        delete cb.dataset.prevChecked;
      }

      cb.disabled = false;
      cb.dataset.pkgLocked = "N";
    }
  }

  function applyOptionLock(optionId) {
    const optCb = document.querySelector(`.option-checkbox[data-option-id="${optionId}"]`);
    if (!optCb) return;

    const lockers = lockedBy.get(optionId);
    const isLocked = lockers && lockers.size > 0;

    const label = optCb.closest("label");
    if (!label) return;

    if (isLocked) {
      if (optCb.dataset.prevChecked === undefined) optCb.dataset.prevChecked = optCb.checked ? "Y" : "N";
      if (optCb.dataset.originalPrice === undefined) optCb.dataset.originalPrice = String(optCb.dataset.price || "0");

      optCb.checked = true;
      optCb.dataset.price = "0";
      optCb.disabled = true;
      optCb.dataset.pkgLocked = "Y";

      if (!label.querySelector(".pkg-included-badge")) {
        const badge = document.createElement("span");
        badge.className = "pkg-included-badge";
        badge.textContent = "[패키지 포함]";
        label.appendChild(badge);
      }
    } else {
      const badge = label.querySelector(".pkg-included-badge");
      if (badge) badge.remove();

      if (optCb.dataset.originalPrice !== undefined) optCb.dataset.price = optCb.dataset.originalPrice;
      if (optCb.dataset.prevChecked !== undefined) {
        optCb.checked = (optCb.dataset.prevChecked === "Y");
        delete optCb.dataset.prevChecked;
      }

      optCb.disabled = false;
      optCb.dataset.pkgLocked = "N";
    }
  }

  const TAB_CATEGORIES = [
    { code: "SEATS", name: "탑승인원" },
    { code: "WHEEL", name: "휠/타이어" },
    { code: "INTERIOR", name: "내부인테리어" },
    { code: "ASSISTANT", name: "주행보조기능" },
    { code: "ETC", name: "기타선택사항" }
  ];

  function renderOptionsByCategoryWithTabs(options) {
    const area = document.getElementById("option-area");
    const tabs = document.getElementById("option-tabs");
    const summary = document.getElementById("selected-summary");

    if (!area || !tabs) return;

    area.innerHTML = "";
    tabs.innerHTML = "";
    if (summary) summary.innerHTML = "";

    if (!options.length) {
      area.innerHTML = "<p>선택 가능한 옵션이 없습니다</p>";
      tabs.style.display = "none";
      if (summary) summary.style.display = "none";
      return;
    }

    const hasByCat = new Map();
    TAB_CATEGORIES.forEach(c => hasByCat.set(c.code, false));
    options.forEach(o => {
      const c = upper(o.optionCategory);
      if (hasByCat.has(c)) hasByCat.set(c, true);
    });

    const enabledTabs = TAB_CATEGORIES.filter(c => hasByCat.get(c.code));

    enabledTabs.forEach((c, idx) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "option-tab" + (idx === 0 ? " active" : "");
      btn.dataset.tab = c.code;
      btn.textContent = c.name;
      btn.addEventListener("click", () => setActiveTab(c.code));
      tabs.appendChild(btn);
    });

    tabs.style.display = enabledTabs.length ? "flex" : "none";

    enabledTabs.forEach((cat, idx) => {
      const panel = document.createElement("div");
      panel.className = "option-panel" + (idx === 0 ? " active" : "");
      panel.dataset.cat = cat.code;

      const title = document.createElement("h3");
      title.textContent = cat.name;
      panel.appendChild(title);

      const items = options.filter(o => upper(o.optionCategory) === cat.code);
      const singleItems = items.filter(o => upper(o.selectRule) === "SINGLE");
      const multiItems  = items.filter(o => upper(o.selectRule) !== "SINGLE");

      if (singleItems.length) {
        const box = document.createElement("div");
        box.className = "opt-box";
        box.innerHTML = `
          <div class="opt-box-title">
            <span>택 1 옵션</span>
            <span class="hint">1개 선택</span>
          </div>
          <div class="opt-box-body" data-box="single"></div>
        `;
        const body = box.querySelector(".opt-box-body");
        singleItems.forEach(opt => body.insertAdjacentHTML("beforeend", optionRowHtml(opt)));
        panel.appendChild(box);
      }

      if (multiItems.length) {
        const box = document.createElement("div");
        box.className = "opt-box";
        box.innerHTML = `
          <div class="opt-box-title">
            <span>추가 선택</span>
            <span class="hint">복수 선택 가능</span>
          </div>
          <div class="opt-box-body" data-box="multi"></div>
        `;
        const body = box.querySelector(".opt-box-body");
        multiItems.forEach(opt => body.insertAdjacentHTML("beforeend", optionRowHtml(opt)));
        panel.appendChild(box);
      }

      area.appendChild(panel);
    });

    keepRequiredChecked();
    enforceRequiresConstraints();
    resortAllPanelsSelectedFirst();
    updateSelectedSummary();
    updateTotalPrice();

    if (summary) summary.style.display = "block";
  }

  function optionRowHtml(opt){
    const isRequired = opt.required === "Y";
    const optId = Number(opt.optionId);
    const optPrice = Number(opt.optionPrice || 0);

    const requiresArr = Array.isArray(opt.requiresOptionIds) ? opt.requiresOptionIds : [];
    const requiresAttr = requiresArr.map(n => Number(n)).filter(n => !Number.isNaN(n)).join(',');

    const excludesArr = Array.isArray(opt.excludesOptionIds) ? opt.excludesOptionIds : [];
    const excludesAttr = excludesArr.map(n => Number(n)).filter(n => !Number.isNaN(n)).join(',');

    const desc = (opt.optionDesc || "").trim();
    const descHtml = desc ? `<div class="opt-desc">${escapeHtml(desc)}</div>` : "";

    const isSingle = upper(opt.selectRule) === "SINGLE";
    const inputType = isSingle ? "radio" : "checkbox";

    const radioKey = isSingle ? getSingleRadioGroupKey(opt) : "";
    const inputName = isSingle ? `group_${radioKey}` : `option_${optId}`;

    const checkedAttr = isRequired ? "checked" : "";

    return `
      <div class="option-item" data-option-item-id="${optId}">
        <label>
          <input type="${inputType}"
                 name="${inputName}"
                 class="option-checkbox"
                 data-option-id="${optId}"
                 data-category="${opt.optionCategory}"
                 data-select-rule="${opt.selectRule}"
                 data-price="${optPrice}"
                 data-required="${isRequired ? "Y" : "N"}"
                 data-pkg-locked="N"
                 data-policy-locked="N"
                 data-requires="${requiresAttr}"
                 data-excludes="${excludesAttr}"
                 ${checkedAttr}>
          ${opt.optionName} (${optPrice.toLocaleString()}원)
        </label>
        ${descHtml}
      </div>
    `;
  }

  function setActiveTab(catCode) {
    document.querySelectorAll("#option-tabs .option-tab")
      .forEach(btn => btn.classList.toggle("active", btn.dataset.tab === catCode));

    document.querySelectorAll("#option-area .option-panel")
      .forEach(p => p.classList.toggle("active", p.dataset.cat === catCode));
  }

  function resortPanelSelectedFirst(panelEl) {
    if (!panelEl) return;

    const boxes = Array.from(panelEl.querySelectorAll(".opt-box-body"));
    if (!boxes.length) return;

    boxes.forEach(box => {
      const items = Array.from(box.querySelectorAll(".option-item"));
      if (!items.length) return;

      const sorted = items.sort((a, b) => {
        const aCb = a.querySelector(".option-checkbox");
        const bCb = b.querySelector(".option-checkbox");

        const aDisabled = aCb?.disabled ? 1 : 0;
        const bDisabled = bCb?.disabled ? 1 : 0;
        if (aDisabled !== bDisabled) return aDisabled - bDisabled;

        const aChecked = aCb?.checked ? 1 : 0;
        const bChecked = bCb?.checked ? 1 : 0;
        return bChecked - aChecked;
      });

      items.forEach(el => el.remove());
      sorted.forEach(el => box.appendChild(el));
    });
  }

  function resortAllPanelsSelectedFirst() {
    document.querySelectorAll("#option-area .option-panel")
      .forEach(panel => resortPanelSelectedFirst(panel));
  }

  /* ================= ✅ 옵션 제어 ================= */
  function handleOptionClick(e) {
    const t = e.target;
    if (!t.classList || !t.classList.contains("option-checkbox")) return;

    // 패키지 포함 잠금은 유지
    if (t.dataset.pkgLocked === "Y") {
      e.preventDefault();
      e.stopPropagation();
      t.checked = true;
      return;
    }

    // 필수 체크박스 해제 방지
    if (t.dataset.required === "Y" && t.type === "checkbox" && t.checked) {
      e.preventDefault();
      e.stopPropagation();
      t.checked = true;
      return;
    }

    // disabled 옵션 클릭 시도 -> requires 강제 선택 -> 가능해지면 체크
    if (t.disabled && !t.checked) {
      e.preventDefault();
      e.stopPropagation();

      forceSelectRequires(t);
      enforceRequiresConstraints();

      if (!t.disabled) {
        t.checked = true;
        t.dispatchEvent(new Event("change", { bubbles:true }));
      }
    }
  }

  function handleOptionChange(e) {
    const target = e.target;
    if (!target.classList.contains("option-checkbox")) return;

    if (target.disabled && target.dataset.pkgLocked === "Y") {
      target.checked = true;
      return;
    }

    if (target.dataset.required === "Y" && target.type === "checkbox") {
      target.checked = true;
    }

    if (target.checked) autoSelectRequires(target);

    resortAllPanelsSelectedFirst();
    enforceRequiresConstraints();
    updateTotalPrice();
    updateSelectedSummary();
  }

  /* ================= 가격 계산 ================= */
  function updateTotalPrice() {
    let total = basePrice;

    const sel = document.getElementById("trimColorSelect");
    if (sel && sel.selectedIndex > 0) {
      total += Number(sel.options[sel.selectedIndex].dataset.price || 0);
    }

    document.querySelectorAll("#option-area .option-checkbox:checked").forEach(opt => {
      total += Number(opt.dataset.price || 0);
    });

    document.querySelectorAll("#package-area input.package-checkbox:checked").forEach(pkg => {
      total += Number(pkg.dataset.price || 0);
    });

    const out = document.getElementById("total-price");
    if (out) out.textContent = total.toLocaleString();
  }
  window.updateTotalPrice = updateTotalPrice;

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll("\"", "&quot;")
      .replaceAll("'", "&#039;");
  }

  function updateSelectedSummary(){
    const summary = document.getElementById("selected-summary");
    if (!summary) return;

    const optionChips = [];
    const pkgMap = new Map();

    document.querySelectorAll('#package-area .package-checkbox:checked').forEach(inp => {
      const pkgId = Number(inp.dataset.packageId);
      if (Number.isNaN(pkgId)) return;

      let labelText = "";
      const labelEl = inp.closest("label");
      if (labelEl) labelText = (labelEl.textContent || "").trim();
      labelText = labelText.split("\n")[0].trim();
      if (!labelText) return;

      if (!pkgMap.has(pkgId)) pkgMap.set(pkgId, { text: `패키지: ${labelText}`, children: [] });
    });

    document.querySelectorAll('#option-area .option-checkbox:checked').forEach(inp => {
      const optId = Number(inp.dataset.optionId);
      if (Number.isNaN(optId)) return;

      const item = inp.closest('.option-item');
      const panel = inp.closest('.option-panel');
      const cat = panel?.dataset?.cat || "";

      let labelText = "";
      const labelEl = item?.querySelector("label");
      if (labelEl) labelText = (labelEl.textContent || "").trim();
      labelText = labelText.split("\n")[0].trim();
      if (!labelText) return;

      if (inp.dataset.pkgLocked === "Y") {
        const lockers = lockedBy.get(optId);
        if (lockers && lockers.size) {
          lockers.forEach(pkgId => {
            if (!pkgMap.has(pkgId)) {
              pkgMap.set(pkgId, { text: `패키지: #${pkgId}`, children: [] });
            }
            const obj = pkgMap.get(pkgId);
            if (obj && !obj.children.includes(labelText)) obj.children.push(labelText);
          });
        }
        return;
      }

      optionChips.push({ type:"option", optId, cat, text: labelText });
    });

    const hasAny = optionChips.length || pkgMap.size;
    if (!hasAny) {
      summary.innerHTML = `
        <div class="summary-title">선택한 옵션</div>
        <div class="summary-empty">아직 선택된 옵션이 없습니다.</div>
      `;
      return;
    }

    summary.innerHTML = `
      <div class="summary-title">선택한 옵션</div>
      <div class="summary-chips"></div>
      <div class="summary-groups"></div>
    `;

    const chipWrap = summary.querySelector(".summary-chips");
    const groupWrap = summary.querySelector(".summary-groups");

    optionChips.forEach(c => {
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "summary-chip";

      const textSpan = document.createElement("span");
      textSpan.textContent = c.text;

      const xBtn = document.createElement("button");
      xBtn.type = "button";
      xBtn.className = "chip-x";
      xBtn.setAttribute("aria-label", "선택 해제");
      xBtn.textContent = "×";

      chip.addEventListener("click", () => {
        if (c.cat) setActiveTab(c.cat);
        const target = document.querySelector(`#option-area .option-item[data-option-item-id="${c.optId}"]`);
        if (target) target.scrollIntoView({ behavior:"smooth", block:"center" });
      });

      xBtn.addEventListener("click", (ev) => {
        ev.preventDefault();
        ev.stopPropagation();

        const inp = document.querySelector(`#option-area .option-checkbox[data-option-id="${c.optId}"]`);
        if (!inp) return;

        if (inp.dataset.required === "Y" && inp.type === "checkbox") return;
        if (inp.dataset.pkgLocked === "Y") return;

        inp.checked = false;
        inp.dispatchEvent(new Event("change", { bubbles:true }));
        updateSelectedSummary();
      });

      chip.appendChild(textSpan);
      chip.appendChild(xBtn);
      chipWrap.appendChild(chip);
    });

    Array.from(pkgMap.entries()).forEach(([pkgId, obj]) => {
      const group = document.createElement("div");
      group.className = "summary-group";

      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "summary-chip";

      const textSpan = document.createElement("span");
      const childCount = obj.children?.length || 0;
      textSpan.textContent = childCount ? `${obj.text} (${childCount}개 포함)` : obj.text;

      const xBtn = document.createElement("button");
      xBtn.type = "button";
      xBtn.className = "chip-x";
      xBtn.setAttribute("aria-label", "패키지 해제");
      xBtn.textContent = "×";

      chip.addEventListener("click", () => {
        const area = document.getElementById("package-area");
        if (area) area.scrollIntoView({ behavior:"smooth", block:"start" });
      });

      xBtn.addEventListener("click", (ev) => {
        ev.preventDefault();
        ev.stopPropagation();

        const inp = document.querySelector(`#package-area .package-checkbox[data-package-id="${pkgId}"]`);
        if (!inp) return;
        if (inp.disabled) return;

        inp.checked = false;
        inp.dispatchEvent(new Event("change", { bubbles:true }));
        updateSelectedSummary();
      });

      chip.appendChild(textSpan);
      chip.appendChild(xBtn);
      group.appendChild(chip);
      groupWrap.appendChild(group);
    });
  }
  window.updateSelectedSummary = updateSelectedSummary;

  // =========================
  // “보이는 스타일”만 동기화 (클래스 토글)
  // =========================
  (function(){
    const mark = (root) => {
      if(!root) return;
      root.querySelectorAll('label').forEach(lab=>{
        const inp = lab.querySelector('input');
        if(!inp) return;
        lab.classList.toggle('is-selected', !!inp.checked);
        lab.classList.toggle('is-disabled', !!inp.disabled);
      });
    };

    const watch = (id) => {
      const el = document.getElementById(id);
      if(!el) return;
      mark(el);
      const mo = new MutationObserver(()=>mark(el));
      mo.observe(el, {subtree:true, childList:true, attributes:true});
    };

    function applyCheckedStyles(root){
      const scope = root || document;
      scope.querySelectorAll('.option-item').forEach(card=>{
        const input = card.querySelector('input.option-checkbox');
        if(!input) return;
        card.classList.toggle('is-checked', !!input.checked);
      });
    }
    window.applyCheckedStyles = applyCheckedStyles;

    // delegate
    document.addEventListener('change', (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLInputElement)) return;
      if(t.classList.contains('option-checkbox')){
        const card = t.closest('.option-item');
        if(card) card.classList.toggle('is-checked', t.checked);
      }
    }, true);

    document.addEventListener('DOMContentLoaded', ()=>{
      watch('color-area');
      watch('package-area');
      watch('option-area');
    });
  })();

});
